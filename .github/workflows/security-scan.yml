name: Security Scan Docker Packages
run-name: >
  Security Scan #${{ github.run_number }} for ${{ inputs.image != '' && inputs.image != null && inputs.image || 'all repository docker images' }}
on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target type for the scan (docker, etc.)"
        required: false
        type: choice
        options:
          - docker
          - source
      image:
        description: "Docker image (for docker). By default ghcr.io/<owner>/<repo>:latest"
        required: false
        default: ""
        type: string
      only-high-critical:
        description: "Scope only HIGH + CRITICAL"
        required: false
        default: true
        type: boolean
      trivy-scan:
        description: "Trivy scan"
        required: false
        default: true
        type: boolean
      grype-scan:
        description: "Grype scan"
        required: false
        default: true
        type: boolean
      continue-on-error:
        description: "Continue on error"
        required: false
        default: true
        type: boolean
      only-fixed:
        description: "Ignore unfixed vulnerabilities"
        required: false
        default: true
        type: boolean
  schedule:
    - cron: "0 3 * * 0" # every Sunday at 03:00 UTC

jobs:
  debug-packages:
    runs-on: ubuntu-latest
    permissions:
      packages: read
    outputs:
      ghcr-packages: ${{ steps.pkgs.outputs.ghcr-packages }}
    steps:
      - name: Show raw GHCR response
        id: pkgs
        env:
          GH_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
                  set -euo pipefail
                  per_page=100
                  page=1
                  filtered_packages='[]'
                  all_packages='[]'

                  echo "Fetching GHCR packages for owner: $OWNER, repo: $REPO"

                  while :; do
                    api_url="https://api.github.com/orgs/${OWNER}/packages?package_type=container&per_page=${per_page}&page=${page}"
                    echo "Request: $api_url"

                    response=$(curl -sS \
                      -H "Authorization: Bearer $GH_TOKEN" \
                      -H "Accept: application/vnd.github+json" \
                      "$api_url")

                    # Если пришёл не массив (например, ошибка), выходим из цикла
                    if ! echo "$response" | jq -e 'type == "array"' >/dev/null 2>&1; then
                      echo "Non-array response from GitHub API (maybe error):"
                      echo "$response"
                      break
                    fi

                    count=$(echo "$response" | jq 'length')
                    echo "Page $page: $count packages"

                    # Пустая страница -> дальше пакетов нет
                    if [ "$count" -eq 0 ]; then
                      echo "No more pages."
                      break
                    fi

                    # Копим все пакеты "как есть" со всех страниц
                    all_packages=$(printf '%s\n%s\n' "$all_packages" "$response" | jq -c -s 'add')

                    # Фильтруем только пакеты этого репозитория по имени
                    page_filtered=$(echo "$response" | jq -c --arg owner "$OWNER" --arg repo "$REPO" '
                      [.[]
                      | select(.name == $repo)
                      | {
                          name: .name,
                          repository: (.repository.name // null),
                          full_name: (.repository.full_name // null),
                          path: "ghcr.io/\($owner)/\(.name)"
                        }
                      ]
                    ')

                    echo "Page $page filtered packages:"
                    echo "$page_filtered" | jq '.'

                    # Склеиваем отфильтрованные пакеты со всех страниц
                    filtered_packages=$(printf '%s\n%s\n' "$filtered_packages" "$page_filtered" | jq -c -s 'add')

                    page=$((page + 1))
                  done

                  echo "Final filtered packages for repo $REPO:"
                  echo "$filtered_packages" | jq '.'

                  echo "Total packages collected (all pages):"
                  echo "$all_packages" | jq 'length'

                  # Сохраняем оба варианта в файлы для артефактов
                  echo "$all_packages" > ghcr_all_packages.json
                  echo "$filtered_packages" > ghcr_filtered_packages.json

                  # Передаём отфильтрованный массив в outputs job'а
                  echo "ghcr-packages=$filtered_packages" >> "$GITHUB_OUTPUT"



          echo "ghcr-packages=$filtered_packages" >> "$GITHUB_OUTPUT"
          # api_url="https://api.github.com/orgs/${OWNER}/packages?package_type=container&per_page=100"
          # echo "Request: $api_url"
          # echo "Fetching GHCR packages for owner: $OWNER, repo: $REPO"

          # response=$(curl -sS \
          #   -H "Authorization: Bearer $GH_TOKEN" \
          #   -H "Accept: application/vnd.github+json" \
          #   "$api_url")


          # echo "=== RAW JSON (pretty) ==="
          # echo "$response" | jq '.'

          # echo "$response" > ghcr_response.json

          # echo "$response" | jq -r '.[].repository.full_name'

          # packages=$(echo "$response" | jq -c --arg owner "$OWNER" --arg repo "$REPO" '
          #   [.[]
          #   | select(.repository.full_name == "\($owner)/\($repo)")
          #   | { name: .name, repository: .repository.name, full_name: .repository.full_name, path: "ghcr.io/\($owner)/\(.name)" }
          #   ]
          # ')

          # echo "ghcr-packages=$packages" >> "$GITHUB_OUTPUT"
          # echo "Parsed packages:"
          # echo "$packages" | jq '.'

      - name: Upload GHCR Raw JSON Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ghcr-response
          path: ghcr_response.json
          # echo "ghcr-packages=$packages" >> "$GITHUB_OUTPUT"
          # echo "Raw response:"
          # echo "$packages"
          # api_url="https://api.github.com/orgs/${OWNER}/packages?package_type=container"
          # echo "Request: $api_url"

          # response=$(curl -sS \
          #   -H "Authorization: Bearer $GH_TOKEN" \
          #   -H "Accept: application/vnd.github+json" \
          #   "$api_url")

          # packages=$(echo "$response" | jq -c --arg owner "$OWNER" --arg repo "$REPO" '
          #   [.[]
          #   | select(.repository.full_name == "\($owner)/\($repo)")
          #   | { name: .name, repository: .repository.name, full_name: .repository.full_name, path: "ghcr.io/\($owner)/\(.name)" }
          #   ]
          # ')

          # echo "ghcr-packages=$packages" >> "$GITHUB_OUTPUT"
          # # echo "Raw response:"
          # # echo "$packages"

          # echo "Parsed packages:"
          # echo "$packages" | jq '.'

  # security-scan-matrix:
  #   needs: debug-packages
  #   if: ${{ inputs.image == '' || inputs.image == null }}
  #   strategy:
  #     matrix:
  #       package: ${{ fromJson(needs.debug-packages.outputs.ghcr-packages) }}

  #   name: "Run Security Scan (matrix)"
  #   uses: netcracker/qubership-workflow-hub/.github/workflows/re-security-scan.yml@main
  #   with:
  #     target: ${{ inputs.target || 'docker' }}
  #     image: ${{ format('{0}:main', matrix.package.path) }}

  # security-scan-single:
  #   needs: debug-packages
  #   if: ${{ inputs.image != '' && inputs.image != null }}
  #   name: "Run Security Scan (single image)"
  #   uses: netcracker/qubership-workflow-hub/.github/workflows/re-security-scan.yml@main
  #   with:
  #     target: ${{ inputs.target || 'docker' }}
  #     image: ${{ inputs.image }}
  #     only-high-critical: ${{ inputs.only-high-critical || true }}
  #     trivy-scan: ${{ inputs.trivy-scan || true }}
  #     grype-scan: ${{ inputs.grype-scan || true }}
  #     only-fixed: ${{ inputs.only-fixed || true }}
  #     continue-on-error: ${{ inputs.continue-on-error || true }}
